<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخازن - Foodics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .floating-cart { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .modal { backdrop-filter: blur(5px); }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white;
                padding: 20px;
                font-size: 12px;
            }
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .print-table th, .print-table td {
                border: 1px solid #333;
                padding: 8px;
                text-align: right;
                font-size: 11px;
            }
            .print-table th {
                background-color: #f0f0f0;
                font-weight: bold;
            }
            .print-footer {
                margin-top: 30px;
                text-align: center;
                font-size: 10px;
                color: #666;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <!-- Admin Button (Hidden by default) -->
    <div id="adminBtn" class="fixed top-4 right-4 z-50 hidden">
        <button onclick="showAdminPanel()" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-all">
            إدارة - Admin
        </button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">نظام إدارة المخازن</h1>
                <h2 class="text-2xl font-bold text-gray-600 mb-4">Inventory Management System</h2>
                <p class="text-gray-600">أدخل رمز الدخول الخاص بك</p>
                <p class="text-gray-500 text-sm">Enter your access code</p>
            </div>
            <div class="space-y-6">
                <input type="text" id="employeeCode" placeholder="رمز الدخول - Access Code" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-xl font-mono">
                <button onclick="login()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all transform hover:scale-105">
                    دخول - Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="mainScreen" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800">مرحباً</h2>
                        <p class="text-sm text-gray-600">Welcome</p>
                    </div>
                    <span id="employeeName" class="text-xl text-blue-600 font-semibold"></span>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">
                    خروج - Logout
                </button>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="max-w-7xl mx-auto p-4">
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <input type="text" id="searchInput" placeholder="البحث عن المنتجات - Search products..." 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                       oninput="searchProducts()">
            </div>
        </div>

        <!-- Products Grid -->
        <div class="max-w-7xl mx-auto p-4">
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <div id="floatingCart" class="floating-cart hidden">
        <button onclick="showCart()" class="bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-all transform hover:scale-110">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"></path>
            </svg>
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">0</span>
        </button>
    </div>

    <!-- Quantity Modal -->
    <div id="quantityModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 slide-up">
            <div class="text-center">
                <img id="modalProductImage" src="" alt="" class="w-32 h-32 object-cover rounded-lg mx-auto mb-4">
                <h3 id="modalProductName" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">الكمية - Quantity</label>
                    <input type="number" id="quantityInput" min="0.1" step="0.1" value="1" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-xl">
                    <p class="text-xs text-gray-500 mt-1">يمكن استخدام الأرقام العشرية (مثل: 1.5, 2.25)</p>
                    <p class="text-xs text-gray-400">Decimal numbers supported (e.g: 1.5, 2.25)</p>
                </div>
                <div class="flex space-x-4 space-x-reverse">
                    <button onclick="closeQuantityModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                        إلغاء - Cancel
                    </button>
                    <button onclick="addToCart()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-all">
                        إضافة - Add
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto slide-up">
            <h3 class="text-2xl font-bold text-gray-800 mb-2 text-center">سلة المنتجات</h3>
            <p class="text-lg text-gray-600 mb-6 text-center">Shopping Cart</p>
            <div id="cartItems" class="space-y-4 mb-6">
                <!-- Cart items will be loaded here -->
            </div>
            <div class="flex space-x-4 space-x-reverse">
                <button onclick="closeCart()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all">
                    متابعة التسجيل<br><span class="text-sm">Continue Shopping</span>
                </button>
                <button onclick="finishOrder()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-all">
                    إنهاء التسجيل<br><span class="text-sm">Finish Order</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center slide-up">
            <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-700 text-lg">انتظر قليلاً...</p>
            <p class="text-gray-500">Please wait...</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center slide-up">
            <div class="text-green-500 text-6xl mb-4">✓</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">شكراً</h3>
            <p class="text-lg text-gray-600 mb-4">Thank you</p>
            <p id="successEmployeeName" class="text-xl text-blue-600 font-semibold mb-4"></p>
            <p class="text-gray-700 mb-2">تم تسجيل المنتجات المصروفة بنجاح</p>
            <p class="text-gray-500 text-sm">Products have been successfully recorded</p>
            <button onclick="closeSuccessModal()" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-all">
                موافق - OK
            </button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen bg-gray-100">
        <header class="bg-white shadow-lg p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">لوحة الإدارة</h2>
                    <p class="text-gray-600">Admin Panel</p>
                </div>
                <button onclick="hideAdminPanel()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">
                    إغلاق - Close
                </button>
            </div>
        </header>

        <div class="max-w-7xl mx-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <button onclick="alert('خاصية التقارير غير متوفرة. تم تعطيلها لأنها تعتمد على نظام قاعدة بيانات سابق.')" class="bg-blue-500 text-white p-6 rounded-lg hover:bg-blue-600 transition-all transform hover:scale-105">
                    <h3 class="text-xl font-bold mb-2">تقارير الصرف</h3>
                    <p class="text-blue-100 mb-2">Expense Reports</p>
                    <p class="text-sm">عرض جميع عمليات الصرف</p>
                    <p class="text-xs text-blue-200">View all expense operations</p>
                </button>
                <button onclick="alert('خاصية إدارة المنتجات غير متوفرة. تم تعطيلها لأنها تعتمد على نظام قاعدة بيانات سابق.')" class="bg-green-500 text-white p-6 rounded-lg hover:bg-green-600 transition-all transform hover:scale-105">
                    <h3 class="text-xl font-bold mb-2">منتجات الصرف</h3>
                    <p class="text-green-100 mb-2">Product Management</p>
                    <p class="text-sm">إدارة المنتجات المتاحة</p>
                    <p class="text-xs text-green-200">Manage available products</p>
                </button>
            </div>
            
            <!-- Admin panel sections removed as they are no longer supported by the Foodics API integration -->
            <div id="reportsSection" class="hidden"></div>
            <div id="productManagementSection" class="hidden"></div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="printArea" class="print-area hidden">
        <!-- Print content will be generated here -->
    </div>

    <script>
        // Foodics API Configuration
        const foodicsConfig = {
            // Note: In a real application, this token should be stored securely on the server side, not hardcoded here.
            accessToken: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI4ZjllYjNmNi02ZWZhLTRmZWYtODk1ZS1kMWJjNDRiYTQ4MWQiLCJqdGkiOiJhZjUwZmU3OWYzYTNhNzM0MTg2ZDYyZWYxMmRlYzQyYjY1YmIzNzdlNzk5MWVjN2VjZjhhMThkNTRhMWM0NTYwNThmODNiYjdhZWM1YTNhZSIsImlhdCI6MTc1NzM0Mjg4Mi42MjY3MywibmJmIjoxNzU3MzQyODgyLjYyNjczLCJleHAiOjE5MTUxMDkyODIuNTk1NTg3LCJzdWIiOiI5ZjkyODA1NC1mZTlkLTRmNzMtYjVhOC1iMjNmZjZjN2FlMmYiLCJzY29wZXMiOlsiZ2VuZXJhbC5yZWFkIiwiaW52ZW50b3J5LnRyYW5zYWN0aW9ucy5yZWFkIiwiaW52ZW50b3J5LnNldHRpbmdzLnJlYWQiLCJpbnZlbnRvcnkuc2V0dGluZ3Mud3JpdGUiLCJpbnZlbnRvcnkudHJhbnNhY3Rpb25zLndyaXRlIl0sImJ1c2luZXNzIjoiOWY5MjgwNTUtMGQ5MC00NTYzLTgyMjItNzNlMWJhMmU4NGE4IiwicmVmZXJlbmNlIjoiMjQ2MDI4In0.baJpKGjlCaa2fmegEA1NVAVYpMvO5-zwmHN_7neRnkJ0cr9534sSBH3ZS42rzkdVEi8L-CH16AN9APmcUROrQiMH7RfCnDWldVCo7cM5DiDc8nuh2xqp4UjIWzzfkeBf8vMf9AAuDIBGFgbExaHuJaX8iixvA5V2LWrKtc0hc5NA2gxJNk6vJcdF08z_Xx3iNVvgje3heidklWF-Im2nsdaTF9iopjyCs3SuAFIWwjYqVs_otCKbhGW_8NHcUYXkFIzsvnCgNuGOATofgPV4Y48w57oc6o1uTGwYjqwxT6JtxrhT0EnNFBeeR2ueAXrG4FlFZAYMyCqGTk7DPwDCFWa2J59P9uzqYcbSaf59E3AOkP4Yp3vipDAnE-rP1kmEBPsp9jYtbMUIrQI0wP6Yh-Ni-UCTXKOwnMNRxXutS2DIxpWmFRZw_FefXEOKRVmNxY7T5s4nPRGxnIkCRYJYJQmrH2hfXLXhf1xJ9LG_38S_i0tYaGDR356F2XRnhl0d7ecBVOxaUkit1LAddYLpa6PQKUOt38OFeBLHayOtCgTlxc5TVFFGbysVVgqUVq7GgM-58Z9yrzvSk2zR55oX2Mha-vm8_ydm-JxnhseDF6iHaRW7Hrg_2FbTWyMUiBkuX40EL47vQ2nfY2yZ-tGMxJRt4iNjhd6ccATZQ7VUORM",
            baseUrl: "http://localhost:3000/api" // Using sandbox URL as per documentation
        };

        // Employee codes with pronunciations
        const employees = {
            '1001': { name: 'عايدة', pronunciation: 'Ayda' },
            '1002': { name: 'سارة', pronunciation: 'Sarah' },
            '1003': { name: 'اوماجي', pronunciation: 'Omaji' },
            '1004': { name: 'شاكيلا', pronunciation: 'Shakila' },
            '1005': { name: 'محمود', pronunciation: 'Mahmoud' },
            '1006': { name: 'جون', pronunciation: 'John' },
            '1007': { name: 'جوهاري', pronunciation: 'Johari' },
            '1008': { name: 'ازيل', pronunciation: 'Azil' },
            '1009': { name: 'رمزي', pronunciation: 'Ramzi' },
            '1010': { name: 'رانيا', pronunciation: 'Rania' },
            '1011': { name: 'اسماء', pronunciation: 'Asma' },
            '1012': { name: 'فيروز', pronunciation: 'Firouz' },
            '1013': { name: 'ناصر', pronunciation: 'Nasser' },
            '1014': { name: 'يوسف', pronunciation: 'Youssef' },
            '1015': { name: 'نعيم', pronunciation: 'Naeem' },
            '1016': { name: 'أحمد', pronunciation: 'Ahmed' },
            '1017': { name: 'نوزيا', pronunciation: 'Nozia' },
            '1018': { name: 'اسحاق', pronunciation: 'Ishaq' }
        };

        // Global variables
        let currentEmployee = null;
        let cart = [];
        let products = [];
        let currentProduct = null;
        let clickCount = 0;

        // Admin access (5 clicks)
        document.addEventListener('click', function() {
            if (document.getElementById('loginScreen').style.display !== 'none') {
                clickCount++;
                if (clickCount >= 5) {
                    document.getElementById('adminBtn').classList.remove('hidden');
                    clickCount = 0;
                }
                setTimeout(() => { clickCount = 0; }, 2000);
            }
        });

        // Login function
        function login() {
            const code = document.getElementById('employeeCode').value;
            if (employees[code]) {
                currentEmployee = { 
                    code: code, 
                    name: employees[code].name,
                    pronunciation: employees[code].pronunciation
                };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                document.getElementById('employeeName').innerHTML = `
                    <div class="text-xl text-blue-600 font-semibold">${currentEmployee.name}</div>
                    <div class="text-sm text-gray-500">(${currentEmployee.pronunciation})</div>
                `;
                loadProducts();
            } else {
                alert('رمز الدخول غير صحيح');
            }
        }

        // Logout function
        function logout() {
            currentEmployee = null;
            cart = [];
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('employeeCode').value = '';
            document.getElementById('floatingCart').classList.add('hidden');
        }

        // Fetch products from Foodics API
        async function fetchProductsFromFoodics() {
            const endpoint = `${foodicsConfig.baseUrl}/inventory/products`;
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${foodicsConfig.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                
                const data = await response.json();
                return data.data; // The products are in the 'data' key
            } catch (error) {
                console.error('Error fetching products from Foodics:', error);
                alert('حدث خطأ في جلب المنتجات من فودكس. يرجى مراجعة console للتفاصيل.');
                return [];
            }
        }
        
        // Load products from Foodics and display them
        async function loadProducts() {
            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');
            
            products = await fetchProductsFromFoodics();
            
            // For demonstration, map Foodics data to our app's structure
            // In a real scenario, you would need to map fields like name, unit, etc.
            // For now, we assume the Foodics API returns a list of products with 'id', 'name', 'sku', 'unit', and 'image'
            displayProducts(products);

            document.getElementById('loadingModal').classList.add('hidden');
            document.getElementById('loadingModal').classList.remove('flex');
        }

        // Display products
        function displayProducts(productsToShow) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            if (productsToShow.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 text-lg">لا توجد منتجات لعرضها.</div>`;
                return;
            }

            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-white rounded-lg shadow-md overflow-hidden';
                productCard.innerHTML = `
                    <div class="aspect-square bg-gray-100 flex items-center justify-center">
                        <img src="${product.image || 'https://via.placeholder.com/200x200/E5E7EB/9CA3AF?text=No+Image'}" 
                             alt="${product.name_localized || product.name}" 
                             class="w-full h-full object-cover"
                             onerror="this.src='https://via.placeholder.com/200x200/E5E7EB/9CA3AF?text=No+Image'">
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-1 text-gray-800">${product.name_localized || product.name || 'غير متوفر'}</h3>
                        <p class="text-gray-600 text-sm mb-1">${product.name_localized_en || product.name || 'N/A'}</p>
                        <p class="text-blue-600 text-xs mb-3 font-medium">الوحدة: ${product.unit_localized || 'غير محدد'}</p>
                        <button onclick="showQuantityModal('${product.id}')" 
                                class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all transform hover:scale-105">
                            إضافة - Add
                        </button>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }

        // Search products
        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredProducts = products.filter(product => 
                (product.name_localized && product.name_localized.toLowerCase().includes(searchTerm)) ||
                (product.name_localized_en && product.name_localized_en.toLowerCase().includes(searchTerm)) ||
                (product.sku && product.sku.toLowerCase().includes(searchTerm))
            );
            displayProducts(filteredProducts);
        }

        // Show quantity modal
        function showQuantityModal(productId) {
            currentProduct = products.find(p => p.id === productId);
            if (currentProduct) {
                document.getElementById('modalProductImage').src = currentProduct.image || 'https://via.placeholder.com/200x200/E5E7EB/9CA3AF?text=No+Image';
                document.getElementById('modalProductName').innerHTML = `
                    <div class="text-xl font-bold text-gray-800">${currentProduct.name_localized || currentProduct.name}</div>
                    <div class="text-lg text-gray-600">${currentProduct.name_localized_en || 'N/A'}</div>
                `;
                document.getElementById('quantityInput').value = 1;
                document.getElementById('quantityModal').classList.remove('hidden');
                document.getElementById('quantityModal').classList.add('flex');
            }
        }

        // Close quantity modal
        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.add('hidden');
            document.getElementById('quantityModal').classList.remove('flex');
            currentProduct = null;
        }

        // Add to cart
        function addToCart() {
            const quantity = parseFloat(document.getElementById('quantityInput').value);
            if (currentProduct && quantity > 0) {
                const existingItem = cart.find(item => item.id === currentProduct.id);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({
                        ...currentProduct,
                        quantity: quantity
                    });
                }
                
                updateCartUI();
                closeQuantityModal();
                
                // Show floating cart button
                document.getElementById('floatingCart').classList.remove('hidden');
            }
        }

        // Update cart UI
        function updateCartUI() {
            const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount.toFixed(1);
        }

        // Show cart
        function showCart() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center space-x-4 space-x-reverse p-4 border rounded-lg';
                cartItem.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/80x80/E5E7EB/9CA3AF?text=No+Image'}" 
                         alt="${item.name_localized}" 
                         class="w-16 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h4 class="font-semibold">${item.name_localized || item.name}</h4>
                        <p class="text-gray-600 text-sm">${item.name_localized_en || 'N/A'}</p>
                        <p class="text-blue-600 text-xs">الوحدة: ${item.unit_localized || 'غير محدد'}</p>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <button onclick="updateCartQuantity(${index}, -0.1)" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600 transition-all text-xs">-</button>
                        <span class="font-bold text-lg px-3">${item.quantity}</span>
                        <button onclick="updateCartQuantity(${index}, 0.1)" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600 transition-all text-xs">+</button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            document.getElementById('cartModal').classList.remove('hidden');
            document.getElementById('cartModal').classList.add('flex');
        }

        // Update cart quantity
        function updateCartQuantity(index, change) {
            cart[index].quantity = Math.round((cart[index].quantity + change) * 10) / 10;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            
            updateCartUI();
            
            if (cart.length === 0) {
                document.getElementById('floatingCart').classList.add('hidden');
                closeCart();
            } else {
                showCart();
            }
        }

        // Close cart
        function closeCart() {
            document.getElementById('cartModal').classList.add('hidden');
            document.getElementById('cartModal').classList.remove('flex');
        }
        
        // Update Foodics inventory
        async function updateFoodicsInventory() {
            const endpoint = `${foodicsConfig.baseUrl}/inventory/transactions`;
            
            // Build the transaction payload for Foodics API
            // This is a simplified example. You would need to check Foodics API docs for exact payload structure.
            const transactionItems = cart.map(item => ({
                id: item.id, // Foodics product ID
                sku: item.sku,
                quantity: item.quantity,
            }));
            
            const payload = {
                items: transactionItems,
                reference: `Makhazin-App-${currentEmployee.code}-${Date.now()}`
            };
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${foodicsConfig.accessToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                
                const responseData = await response.json();
                console.log('Foodics API Response:', responseData);
                return true; // Indicate success
                
            } catch (error) {
                console.error('Error updating Foodics inventory:', error);
                return false; // Indicate failure
            }
        }

        // Finish order
        async function finishOrder() {
            if (cart.length === 0) return;
            
            closeCart();
            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');
            
            try {
                const success = await updateFoodicsInventory();
                
                if (success) {
                    // Clear cart
                    cart = [];
                    updateCartUI();
                    document.getElementById('floatingCart').classList.add('hidden');
                    
                    // Show success modal
                    document.getElementById('loadingModal').classList.add('hidden');
                    document.getElementById('loadingModal').classList.remove('flex');
                    
                    document.getElementById('successEmployeeName').innerHTML = `
                        <div class="text-xl text-blue-600 font-semibold">${currentEmployee.name}</div>
                        <div class="text-sm text-gray-500">(${currentEmployee.pronunciation || 'N/A'})</div>
                    `;
                    document.getElementById('successModal').classList.remove('hidden');
                    document.getElementById('successModal').classList.add('flex');
                } else {
                    document.getElementById('loadingModal').classList.add('hidden');
                    document.getElementById('loadingModal').classList.remove('flex');
                    alert('حدث خطأ في معالجة الطلب');
                }
                
            } catch (error) {
                console.error('Error processing order:', error);
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
                alert('حدث خطأ في معالجة الطلب');
            }
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
            logout();
        }

        // Admin functions
        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminBtn').classList.add('hidden');
        }

        // The following functions are no longer supported due to the switch from Firebase
        function showReports() { alert('خاصية التقارير غير متوفرة. تم تعطيلها لأنها تعتمد على نظام قاعدة بيانات سابق.'); }
        function showProductManagement() { alert('خاصية إدارة المنتجات غير متوفرة. تم تعطيلها لأنها تعتمد على نظام قاعدة بيانات سابق.'); }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support for login
            document.getElementById('employeeCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Enter key support for quantity input
            document.getElementById('quantityInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addToCart();
                }
            });
        });
    </script>
</body>
</html>
